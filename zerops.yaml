zerops:
  - setup: umami
    build:
      base: nodejs@22
      envVariables:
        DATABASE_URL: ${db_connectionString}/${db_dbName}
        NEXT_TELEMETRY_DISABLED: 1
      prepareCommands:
        - sudo apk add --no-cache git
      buildCommands:
        - git clone https://github.com/umami-software/umami.git
        - |
          cd umami
          git checkout tags/v3.0.1
          pnpm install --frozen-lockfile
          cp docker/middleware.ts src/
          pnpm build-docker
      deployFiles:
        - umami/~public/
        - umami/~prisma/
        - umami/~scripts/
        - umami/~generated/
        - umami/.next/standalone/~
        - umami/~.next/static/
    deploy:
      readinessCheck:
        httpGet:
          port: 3000
          path: /api/heartbeat
    run:
      base: nodejs@22
      envVariables:
        NODE_ENV: production
        DATABASE_URL: ${db_connectionString}/${db_dbName}
        NEXT_TELEMETRY_DISABLED: 1
      ports:
        - port: 3000
          httpSupport: true
      initCommands:
        - zsc scale ram +2GB 10m
        - sleep 10s
        - NODE_OPTIONS="--max-old-space-size=2048" pnpm add npm-run-all dotenv chalk semver prisma@6.18.0 @prisma/adapter-pg@6.18.0
        - zsc scale ram auto
      start: pnpm start-docker
      healthCheck:
        httpGet:
          port: 3000
          path: /api/heartbeat
