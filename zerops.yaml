zerops:
  - setup: umami
    build:
      base: nodejs@22
      envVariables:
        DATABASE_URL: ${db_connectionString}/${db_dbName}
        NEXT_TELEMETRY_DISABLED: 1
        UMAMI_RELEASE_TAG: ${RUNTIME_UMAMI_RELEASE_TAG:-v3.0.1}
      prepareCommands:
        - sudo apk add --no-cache git
      buildCommands:
        - git clone --branch $UMAMI_RELEASE_TAG --single-branch https://github.com/umami-software/umami.git
        - |
          cd umami
          pnpm install --frozen-lockfile
          pnpm build
      deployFiles:
        # Using '~' wildcard to shorten the deployment path:
        # https://docs.zerops.io/zerops-yaml/specification#using-wildcards
        - umami/.next/standalone/~
        
        # Handles 'cp -r public .next/standalone/ && cp -r .next/static .next/standalone/.next/' command
        # required for standalone Next.js builds.
        # See: https://nextjs.org/docs/pages/api-reference/config/next-config-js/output#automatically-copying-traced-files
        - umami/~.next/static/
        - umami/~public/
        
        # Deploy files allowing for maintenance tasks
        # right from the runtime container.
        # Notice that some extra steps described
        # in knowledge base section of the README.md
        # are required to run.
        - umami/~prisma/
        - umami/~scripts/
        - umami/~generated/

      # Reuse global pnpm 'node_modules' cache,
      # which significantly speeds up 'pnpm install'.
      cache: true
    deploy:
      readinessCheck:
        httpGet:
          port: 3000
          path: /api/heartbeat
    run:
      base: nodejs@22
      envVariables:
        NODE_ENV: production
        DATABASE_URL: ${db_connectionString}/${db_dbName}
        NEXT_TELEMETRY_DISABLED: 1
      ports:
        - port: 3000
          httpSupport: true
      # Simply start the standalone Next.js app.
      start: node server.js
      healthCheck:
        httpGet:
          port: 3000
          path: /api/heartbeat
