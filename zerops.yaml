zerops:
  - setup: umami
    build:
      base: nodejs@22
      envVariables:
        DATABASE_URL: ${db_connectionString}/${db_dbName}
        NEXT_TELEMETRY_DISABLED: 1
      prepareCommands:
        - sudo apk add --no-cache git
      buildCommands:
        - git clone https://github.com/umami-software/umami.git
        - |
          cd umami
          git checkout tags/v3.0.1
          pnpm install --frozen-lockfile
          pnpm build-docker
      deployFiles:
        # Using '~' wildcard to shorten the deployment path:
        # https://docs.zerops.io/zerops-yaml/specification#using-wildcards
        - umami/.next/standalone/~
        # Handles 'cp -r public .next/standalone/ && cp -r .next/static .next/standalone/.next/'
        # See: https://nextjs.org/docs/pages/api-reference/config/next-config-js/output#automatically-copying-traced-files
        - umami/~.next/static/
        - umami/~public/
      cache: true
    deploy:
      readinessCheck:
        httpGet:
          port: 3000
          path: /api/heartbeat
    run:
      base: nodejs@22
      envVariables:
        NODE_ENV: production
        DATABASE_URL: ${db_connectionString}/${db_dbName}
        NEXT_TELEMETRY_DISABLED: 1
      ports:
        - port: 3000
          httpSupport: true
      start: node server.js
      healthCheck:
        httpGet:
          port: 3000
          path: /api/heartbeat
